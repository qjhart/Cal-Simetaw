#! /usr/bin/make -f

#select count(*) from weather where m NOT IN ('E','M','S','(');

ifndef configure.mk
include configure.mk
endif

downloads:=2569932115797  5963302115799  9286862115800
stations:=$(patsubst %,db/%stn.txt,${downloads})
weather:=$(patsubst %,db/%dat.txt,${downloads})

db/ncdc:
	${PG} -f ncdc/schema.sql
	touch $@

.PHONY: stations
stations:${stations}

${stations}:db/%:%
	cat ncdc/add_station.sql | sed -e "s|stn.txt|`pwd`/$<|" | ${PG} -f -
	touch $@

.PHONY: weather
weather:${weather}

${weather}:db/%:%
	cat ncdc/add_weather.sql | sed -e "s|dat.txt|`pwd`/$<|" | ${PG} -f -
	touch $@

db/ncdc.prism.${MAPSET}:db/ncdc.prism.%:${rast}/mTx ${rast}/mTn ${rast}/mPCP
	$(PG) -c "delete from ncdc.prism where year=${YYYY} and month=${MM}";
	$(PG) -F' ' -A -t -c "select x(centroid),y(centroid),station_id|| \
	'|${YYYY}|${MM}' from ncdc.station" |\
	r.what input=mTn@$*,mTx@$*,mPCP@$* |\
	cut --delimiter="|" --fields='3-'  |\
	${PG} -c "COPY ncdc.prism from STDIN using delimiters '|' with NULL as '*'"; 
#	touch $@


